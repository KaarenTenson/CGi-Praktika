<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/ext/json-enc.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

<div class="container mx-auto p-6">
    <h1 class="text-4xl font-bold text-center mb-6">Flight Seating</h1>

    <!-- Flight Info -->
    <div class="bg-white shadow-md p-6 rounded-lg mb-6">
        <h2 class="text-2xl font-semibold mb-2">‚úàÔ∏è Flight Details</h2>
        <p class="text-gray-700"><strong>Price per Seat:</strong> <span th:text="${flight.price}"></span></p>
        <p class="text-gray-700"><strong>Departure Time:</strong> <span th:text="${flight.departureTime}"></span></p>
        <p class="text-gray-700"><strong>Flight Time:</strong> <span th:text="${flight.flightTime}"></span></p>
    </div>

    <!-- Ticket List -->
    <div class="bg-white shadow-md p-6 rounded-lg mb-6">
        <h2 class="text-2xl font-semibold mb-3">üé´ Selected Tickets</h2>
        <ul id="tickets" class="space-y-2">
            <!-- Selected seats will be added here -->
        </ul>
        <p id="price" class="mt-4 text-lg font-bold">Total: $0</p>
        <button
                id="purchase-btn"
                onclick="purchaseSeats()"
        >Purchase</button>
    </div>

    <!-- Seat Type Legend -->
    <div class="flex justify-center space-x-4 mb-4">
        <div class="flex items-center"><div class="w-5 h-5 bg-green-500 border border-gray-300 mr-2"></div> Seat</div>
        <div class="flex items-center"><div class="w-5 h-5 bg-blue-500 border border-gray-300 mr-2"></div> Door</div>
        <div class="flex items-center"><div class="w-5 h-5 bg-red-500 border border-gray-300 mr-2"></div> Occupied</div>
        <div class="flex items-center"><div class="w-5 h-5 bg-gray-300 border border-gray-500 mr-2"></div> Pass through</div>
    </div>
    <!-- Seat Type Legend -->
    <div class="flex justify-center space-x-4 mb-4">
        <label for="seatCount">choose number of seats</label><input type="number" name="number of seats" id="seatCount">
        <label for="nearWindow">Seats are near the windows</label><input type="checkbox" name="nearWindow" id="nearWindow">
        <button onclick="recommendSeats()">recommend</button>

    </div>

    <!-- Seating Layout -->
    <div class="bg-gray-100 p-6 rounded-lg shadow-lg border border-gray-400 w-fit mx-auto">
        <table class="border-collapse border border-gray-300 mx-auto bg-white rounded-lg shadow-md">
            <tbody>
            <tr th:each="row : ${flight.seats.getPlaneStructure()}" class="even:bg-gray-50">
                <!-- Left Window -->
                <td class="w-10"
                    th:classappend="${flight.seats.windows[row[0].row][0]==1} ? 'bg-blue-400 rounded-md shadow-sm' : 'invisible'">
                </td>

                <!-- Seats -->
                <td th:each="seat : ${row}"
                    th:text="${seat.row} + ' - ' + ${seat.column}"
                    th:attr="id=${seat.row} + '-' + ${seat.column}"
                    th:if="${seat.seatType}"
                    th:classappend="
                        ${seat.seatType == 'passThrough'} ? 'invisible' :
                        (${!seat.isAvailable} ? 'bg-red-600 text-white' :
                        (${seat.seatType == 'door'} ? 'bg-blue-700 text-white font-bold' :
                        (${seat.seatType == 'seat'} ? 'bg-green-500 hover:text-white cursor-pointer border-1 border-green-700' : 'bg-gray-300')))"
                    class="border border-gray-400 px-6 py-3 text-center font-medium rounded-lg shadow-md">
                </td>

                <!-- Right Window -->
                <td class="w-10"
                    th:classappend="${flight.seats.windows[row[0].row][1]==1} ? 'bg-blue-400 rounded-md shadow-sm' : 'invisible'">
                </td>
            </tr>
            </tbody>
        </table>
    </div>

</div>

<script th:inline="javascript">
    const price = /*[[${flight.price}]]*/ 0;
    const flightId = /*[[${flight.id}]]*/ 0;
    const tickets=[]
    const seats =  /*[[${flight.seats.getPlaneStructure()}]]*/ null;
    const chosenSeats=[]
    //console.log(seats)
    function seatSelectedEvent(event){
        const seatElement = event.target;
        selectSeat(seatElement);
    }
    function selectSeat(seatElement) {
        const ticketList = document.querySelector("#tickets");

        seatElement.classList.toggle('bg-yellow-500');
        seatElement.classList.toggle('bg-green-500');

        if (seatElement.classList.contains('bg-yellow-500')) {
            tickets.push(seatElement.innerText)
            // Create ticket item
            const ticketItem = document.createElement("li");
            ticketItem.classList.add("bg-gray-200", "rounded-lg", "p-2", "shadow-sm", "flex", "justify-between", "items-center");
            ticketItem.innerHTML = `
                <span class="text-lg">${seatElement.innerText}</span>
                <button class="text-red-500 hover:text-red-700 font-bold" onclick="removeTicket(this, '${seatElement.innerText}')">‚úñ</button>
            `;
            ticketItem.setAttribute("data-seat", seatElement.innerText);
            ticketList.appendChild(ticketItem);
        } else {
            ticketList.querySelectorAll("li").forEach(ticket => {
                if (ticket.getAttribute("data-seat") === seatElement.innerText) {
                    ticket.remove();
                }
            });
        }

        updateTotalPrice();
    }
    function removeTicket(button, seatText) {
        document.querySelectorAll("td").forEach(seat => {
            if (seat.innerText === seatText) {
                tickets.splice(
                    tickets.findIndex(ticket => ticket === seat.innerText),
                    1
                );
                seat.classList.remove("bg-yellow-500");
                seat.classList.add("bg-green-500");
            }
        });

        button.parentElement.remove();
        updateTotalPrice();
    }

    function updateTotalPrice() {
        const ticketList = document.querySelector("#tickets");
        const priceText = document.querySelector("#price");
        priceText.innerText = "Total: $" + (price * ticketList.children.length);
    }
    function getTickets(){
        const ticketsList=document.querySelectorAll("#tickets li");
        const ticketNames=[];
        ticketsList.forEach(function(ticket){
            ticketNames.push(ticket.getAttribute("data-seat"));
        })
        return ticketNames;
    }
    function clearTickets(){
        const ticketsList=document.querySelectorAll("#tickets li");
        ticketsList.forEach(function(ticket){
            removeTicket(ticket.childNodes.item(0), ticket.getAttribute("data-seat"));
        })
    }
    function recommendSeats(){
        clearTickets()
        const numberOfSeats=document.getElementById("seatCount").value;
        const nearWindows=document.getElementById("nearWindow").value;
        let seatRecommended=0;
        console.log(seats)
        for (const row in seats){
            console.log(row)
            for(const column in seats[row]){
                let seat=seats[row][column]
                if(seat.isAvailable && seat.seatType==="seat"){
                    console.log(seat)
                    selectSeat(document.getElementById(seat.row + '-' + seat.column));
                    seatRecommended+=1;
                }
                if(seatRecommended>=numberOfSeats){
                    return;
                }
            }
        }
    }
    function purchaseSeats() {
        const tickets = getTickets();
        console.log("Tickets:", tickets); // Debugging
        var JsonData={tickets: tickets};
        htmx.ajax('POST', '/seating/purchase/' + flightId, {
            headers: {
                'Content-Type': 'application/json'
            },
            swap: 'afterbegin',
            target: 'body',
            values: JsonData, // Pass the raw object (HTMX will encode it)
            ext: {
                'json-enc': true  // Enable JSON encoding extension
            }
        }).then(function(response) {
            console.log('Response:', response);
        }).catch(function(error) {
            console.error('Error:', error);
        });
    }


    document.querySelectorAll('td').forEach(function(seat) {
        if (!seat.classList.contains('bg-red-500') && !seat.classList.contains('bg-blue-500')) {
            seat.addEventListener('click', seatSelectedEvent);
        }
    });




</script>

</body>
</html>
